{"ast":null,"code":"var _jsxFileName = \"/Users/zh/Desktop/project/vote/vote-react/src/ViewVote.js\",\n    _s = $RefreshSig$();\n\n// 投票查看及交互页面\nimport { useParams } from 'react-router-dom';\nimport axios from 'axios';\nimport { useEffect, useState, useMemo } from 'react';\nimport { forceLogin, useAxios } from './hooks';\nimport './ViewVote.css';\nimport _ from 'lodash';\nimport dayjs from 'dayjs';\nimport { useImmer } from 'use-immer';\n/**\r\n * 投票页面的信息是实时更新的\r\n * 实现这个需求有两种方案：\r\n * 一是页面加载成功后一直不断的发ajax请求来获取最新的数据，并展示出来\r\n *  这种做法在投票已经创建出很久以后就不够好了，因为如果创建出很久以后，大概率是不会更新的\r\n *  发出请求大概率是没有获取到最新信息的\r\n * 第二种方案为http长连接，也叫comet，即服务器在收到客户端发来的ajax请求后\r\n *  如果没有数据要回复给客户端，则服务器hold住这个连接，直到超时后响应空内容，或在有数据后立刻响应该请求\r\n *    微信/钉钉的登陆都是这个方案\r\n * 第三种：websocket\r\n *  页面加载成功后向服务器建立一个websocket连接，如果服务器有新的数据，则直接在这个ws连接上响应客户端\r\n *    而不用客户端主动的一直发请求\r\n *\r\n *\r\n *\r\n */\n\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction ViewVote({\n  userInfo\n}) {\n  _s();\n\n  var _ref;\n\n  var {\n    voteId\n  } = useParams();\n  var {\n    loading,\n    data,\n    error,\n    update\n  } = useAxios({\n    url: `/vote/${voteId}`\n  });\n  var [userVotes, setUserVotes] = useState(); // 从websocket上获取到的实时信息\n\n  var [selectedOptionIds, setSelectedOptionIds] = useImmer([]);\n  useEffect(() => {\n    // debugger\n    // 如果还在加载，或者是超过截止时间，则什么也不做\n    if (loading || Date.now() > new Date(data.vote.deadline).getTime()) {\n      return;\n    }\n\n    var wsUrl = `${window.location.protocol.replace('http', 'ws')}//${window.location.host}/realtime-voteinfo/${voteId}`; // var wsUrl = `ws://localhost:8081/realtime-voteinfo/${voteId}`\n\n    console.log(wsUrl);\n    var ws = new WebSocket(wsUrl); // 服务器发来的就是当前投票的最新投票信息\n\n    ws.onmessage = function (e) {\n      var data = JSON.parse(e.data);\n      console.log('从websocket获取到的实时投票信息', data);\n      setUserVotes(data);\n    };\n\n    return () => ws.close();\n  }, [loading, voteId]); // 为某个选项投票/或取消投票\n\n  async function voteOption(option) {\n    if (!data.vote.anonymous) {\n      var {\n        optionId\n      } = option;\n      await axios.post(`/vote/${voteId}`, {\n        optionIds: [optionId]\n      });\n    } else {\n      // 匿名的话，发选中的\n      await axios.post(`/vote/${voteId}`, {\n        optionIds: selectedOptionIds\n      });\n      setSelectedOptionIds([]);\n    }\n  }\n\n  function selectOption(option) {\n    var {\n      optionId\n    } = option;\n\n    if (selectedOptionIds.includes(optionId)) {\n      setSelectedOptionIds(selectedOptionIds => {\n        var idx = selectedOptionIds.indexOf(optionId);\n        selectedOptionIds.splice(idx, 1);\n      });\n    } else {\n      setSelectedOptionIds(selectedOptionIds => {\n        selectedOptionIds.push(optionId);\n      });\n    }\n  }\n\n  function handleOptionClick(option) {\n    if (data.vote.anonymous) {\n      if (votes.some(it => it.userId === userInfo.data.userId)) {\n        return;\n      }\n\n      selectOption(option);\n    } else {\n      voteOption(option);\n    }\n  }\n\n  var votes = (_ref = userVotes !== null && userVotes !== void 0 ? userVotes : data === null || data === void 0 ? void 0 : data.userVotes) !== null && _ref !== void 0 ? _ref : [];\n  var groupedVotes = useMemo(() => _.groupBy(votes, 'optionId'), [votes]);\n  var uniqueUserCount = useMemo(() => _.uniqBy(votes, 'userId').length, [votes]); // 去重后用户数量\n  // console.log('分组后的投票数据', groupedVotes)\n  // console.log('去重后的投票人数', uniqueUserCount)\n\n  if (loading) return 'Loading...';\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n      children: data.vote.title\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n      style: {\n        color: '#3269da'\n      },\n      children: [\"[\", data.vote.multiple ? '多选' : '单选', \"]\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 113,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n      style: {\n        color: '#3269da'\n      },\n      children: [\"[\", data.vote.anonymous ? '匿名' : '公开', \"]\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 116,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"h3\", {\n      children: data.vote.desc\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 119,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n      children: data.options.map(option => {\n        // option 是选项本身\n        // 当前选项的票数信息\n        var thisOptionVotes = groupedVotes[option.optionId] || [];\n        return /*#__PURE__*/_jsxDEV(\"li\", {\n          onClick: () => handleOptionClick(option),\n          children: [option.content, \"[\", thisOptionVotes.length, \"\\u7968] [\", uniqueUserCount === 0 ? 0 : (thisOptionVotes.length / uniqueUserCount * 100).toFixed(2), \"%]\", thisOptionVotes.some(it => it.userId === userInfo.data.userId) ? '✔️' : '', selectedOptionIds.includes(option.optionId) ? '✔️' : '', /*#__PURE__*/_jsxDEV(\"div\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 138,\n            columnNumber: 15\n          }, this), thisOptionVotes.map(oneVote => {\n            return /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"user-id\",\n              children: oneVote.userId\n            }, oneVote.userId, false, {\n              fileName: _jsxFileName,\n              lineNumber: 146,\n              columnNumber: 19\n            }, this);\n          })]\n        }, option.optionId, true, {\n          fileName: _jsxFileName,\n          lineNumber: 127,\n          columnNumber: 13\n        }, this);\n      })\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 120,\n      columnNumber: 7\n    }, this), !!data.vote.anonymous && !votes.some(it => it.userId === userInfo.data.userId) && /*#__PURE__*/_jsxDEV(\"button\", {\n      disabled: !selectedOptionIds.length,\n      onClick: voteOption,\n      children: \"\\u786E\\u5B9A\\u6295\\u7968\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 159,\n      columnNumber: 11\n    }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n      children: [\"\\u6295\\u7968\\u622A\\u6B62: \", dayjs(data.vote.deadline).format('YYYY-MM-DD HH:mm')]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 164,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 111,\n    columnNumber: 5\n  }, this);\n}\n\n_s(ViewVote, \"Z2NojYdiLcLBLO8yRwqtT1lBAsc=\", false, function () {\n  return [useParams, useAxios, useImmer];\n});\n\n_c = ViewVote;\nexport default _c2 = forceLogin(ViewVote);\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"ViewVote\");\n$RefreshReg$(_c2, \"%default%\");","map":{"version":3,"sources":["/Users/zh/Desktop/project/vote/vote-react/src/ViewVote.js"],"names":["useParams","axios","useEffect","useState","useMemo","forceLogin","useAxios","_","dayjs","useImmer","ViewVote","userInfo","voteId","loading","data","error","update","url","userVotes","setUserVotes","selectedOptionIds","setSelectedOptionIds","Date","now","vote","deadline","getTime","wsUrl","window","location","protocol","replace","host","console","log","ws","WebSocket","onmessage","e","JSON","parse","close","voteOption","option","anonymous","optionId","post","optionIds","selectOption","includes","idx","indexOf","splice","push","handleOptionClick","votes","some","it","userId","groupedVotes","groupBy","uniqueUserCount","uniqBy","length","title","color","multiple","desc","options","map","thisOptionVotes","content","toFixed","oneVote","format"],"mappings":"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","sourcesContent":["// 投票查看及交互页面\r\n\r\nimport { useParams } from 'react-router-dom'\r\nimport axios from 'axios'\r\nimport { useEffect, useState, useMemo } from 'react'\r\nimport { forceLogin, useAxios } from './hooks'\r\nimport './ViewVote.css'\r\nimport _ from 'lodash'\r\nimport dayjs from 'dayjs'\r\nimport { useImmer } from 'use-immer'\r\n\r\n/**\r\n * 投票页面的信息是实时更新的\r\n * 实现这个需求有两种方案：\r\n * 一是页面加载成功后一直不断的发ajax请求来获取最新的数据，并展示出来\r\n *  这种做法在投票已经创建出很久以后就不够好了，因为如果创建出很久以后，大概率是不会更新的\r\n *  发出请求大概率是没有获取到最新信息的\r\n * 第二种方案为http长连接，也叫comet，即服务器在收到客户端发来的ajax请求后\r\n *  如果没有数据要回复给客户端，则服务器hold住这个连接，直到超时后响应空内容，或在有数据后立刻响应该请求\r\n *    微信/钉钉的登陆都是这个方案\r\n * 第三种：websocket\r\n *  页面加载成功后向服务器建立一个websocket连接，如果服务器有新的数据，则直接在这个ws连接上响应客户端\r\n *    而不用客户端主动的一直发请求\r\n *\r\n *\r\n *\r\n */\r\nfunction ViewVote({ userInfo }) {\r\n  var { voteId } = useParams()\r\n  var { loading, data, error, update } = useAxios({ url: `/vote/${voteId}` })\r\n  var [userVotes, setUserVotes] = useState() // 从websocket上获取到的实时信息\r\n  var [selectedOptionIds, setSelectedOptionIds] = useImmer([])\r\n\r\n  useEffect(() => {\r\n    // debugger\r\n    // 如果还在加载，或者是超过截止时间，则什么也不做\r\n    if (loading || Date.now() > new Date(data.vote.deadline).getTime()) {\r\n      return\r\n    }\r\n\r\n    var wsUrl = `${window.location.protocol.replace('http', 'ws')}//${\r\n      window.location.host\r\n    }/realtime-voteinfo/${voteId}`\r\n    // var wsUrl = `ws://localhost:8081/realtime-voteinfo/${voteId}`\r\n\r\n    console.log(wsUrl)\r\n    var ws = new WebSocket(wsUrl)\r\n\r\n    // 服务器发来的就是当前投票的最新投票信息\r\n    ws.onmessage = function (e) {\r\n      var data = JSON.parse(e.data)\r\n      console.log('从websocket获取到的实时投票信息', data)\r\n      setUserVotes(data)\r\n    }\r\n\r\n    return () => ws.close()\r\n  }, [loading, voteId])\r\n\r\n  // 为某个选项投票/或取消投票\r\n  async function voteOption(option) {\r\n    if (!data.vote.anonymous) {\r\n      var { optionId } = option\r\n      await axios.post(`/vote/${voteId}`, {\r\n        optionIds: [optionId],\r\n      })\r\n    } else {\r\n      // 匿名的话，发选中的\r\n      await axios.post(`/vote/${voteId}`, {\r\n        optionIds: selectedOptionIds,\r\n      })\r\n      setSelectedOptionIds([])\r\n    }\r\n  }\r\n\r\n  function selectOption(option) {\r\n    var { optionId } = option\r\n    if (selectedOptionIds.includes(optionId)) {\r\n      setSelectedOptionIds((selectedOptionIds) => {\r\n        var idx = selectedOptionIds.indexOf(optionId)\r\n        selectedOptionIds.splice(idx, 1)\r\n      })\r\n    } else {\r\n      setSelectedOptionIds((selectedOptionIds) => {\r\n        selectedOptionIds.push(optionId)\r\n      })\r\n    }\r\n  }\r\n\r\n  function handleOptionClick(option) {\r\n    if (data.vote.anonymous) {\r\n      if (votes.some((it) => it.userId === userInfo.data.userId)) {\r\n        return\r\n      }\r\n      selectOption(option)\r\n    } else {\r\n      voteOption(option)\r\n    }\r\n  }\r\n\r\n  var votes = userVotes ?? data?.userVotes ?? []\r\n\r\n  var groupedVotes = useMemo(() => _.groupBy(votes, 'optionId'), [votes])\r\n  var uniqueUserCount = useMemo(() => _.uniqBy(votes, 'userId').length, [votes]) // 去重后用户数量\r\n\r\n  // console.log('分组后的投票数据', groupedVotes)\r\n  // console.log('去重后的投票人数', uniqueUserCount)\r\n\r\n  if (loading) return 'Loading...'\r\n\r\n  return (\r\n    <div>\r\n      <h2>{data.vote.title}</h2>\r\n      <span style={{ color: '#3269da' }}>\r\n        [{data.vote.multiple ? '多选' : '单选'}]\r\n      </span>\r\n      <span style={{ color: '#3269da' }}>\r\n        [{data.vote.anonymous ? '匿名' : '公开'}]\r\n      </span>\r\n      <h3>{data.vote.desc}</h3>\r\n      <ul>\r\n        {data.options.map((option) => {\r\n          // option 是选项本身\r\n          // 当前选项的票数信息\r\n          var thisOptionVotes = groupedVotes[option.optionId] || []\r\n\r\n          return (\r\n            <li onClick={() => handleOptionClick(option)} key={option.optionId}>\r\n              {option.content}[{thisOptionVotes.length}票] [\r\n              {uniqueUserCount === 0\r\n                ? 0\r\n                : ((thisOptionVotes.length / uniqueUserCount) * 100).toFixed(2)}\r\n              %]\r\n              {/* 当选选项的任意一票是当前登陆用户，则说明当前用户已经选择该选项 */}\r\n              {thisOptionVotes.some((it) => it.userId === userInfo.data.userId)\r\n                ? '✔️'\r\n                : ''}\r\n              {selectedOptionIds.includes(option.optionId) ? '✔️' : ''}\r\n              <div />\r\n              {/* {\r\n                  thisOptionVotes.map(oneVote => {\r\n                    return <img width=\"32\" height=\"32\" src={oneVote.avatar ?? 'https://www.12306.cn/index/images/service.png'} style={{borderRadius: '9999px', margin: '2px'}} />\r\n                  })\r\n                } */}\r\n              {thisOptionVotes.map((oneVote) => {\r\n                return (\r\n                  <span key={oneVote.userId} className=\"user-id\">\r\n                    {oneVote.userId}\r\n                  </span>\r\n                )\r\n              })}\r\n            </li>\r\n          )\r\n        })}\r\n      </ul>\r\n\r\n      {/* 匿名且当前用户没投过才显示确定投票 */}\r\n      {!!data.vote.anonymous &&\r\n        !votes.some((it) => it.userId === userInfo.data.userId) && (\r\n          <button disabled={!selectedOptionIds.length} onClick={voteOption}>\r\n            确定投票\r\n          </button>\r\n        )}\r\n\r\n      <p>投票截止: {dayjs(data.vote.deadline).format('YYYY-MM-DD HH:mm')}</p>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default forceLogin(ViewVote)\r\n"]},"metadata":{},"sourceType":"module"}